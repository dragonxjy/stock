var E=Object.defineProperty,M=Object.defineProperties;var N=Object.getOwnPropertyDescriptors;var A=Object.getOwnPropertySymbols;var _=Object.prototype.hasOwnProperty,R=Object.prototype.propertyIsEnumerable;var S=(s,e,t)=>e in s?E(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,f=(s,e)=>{for(var t in e||(e={}))_.call(e,t)&&S(s,t,e[t]);if(A)for(var t of A(e))R.call(e,t)&&S(s,t,e[t]);return s},P=(s,e)=>M(s,N(e));var w=(s,e,t)=>S(s,typeof e!="symbol"?e+"":e,t);var d=(s,e,t)=>new Promise((i,n)=>{var r=u=>{try{m(t.next(u))}catch(g){n(g)}},p=u=>{try{m(t.throw(u))}catch(g){n(g)}},m=u=>u.done?i(u.value):Promise.resolve(u.value).then(r,p);m((t=t.apply(s,e)).next())});import{u as B,I,J as K,K as O,L as z,M as F,N as J,O as j}from"./index-BXVDO5jB.js";import{a9 as C,d as L,r as l,R as H,a8 as $,am as T,N as U,an as V}from"./vendor-DixqdoKt.js";import{l as y}from"./loading-8XKiFQcW.js";import{f as Y}from"./index-BW6EuzMu.js";class Z{constructor(){w(this,"socket",null);w(this,"reconnectInterval",3e3);w(this,"maxReconnectAttempts",5);w(this,"reconnectAttempts",0);w(this,"reconnectTimer",null);w(this,"isConnected",!1);console.log("[socket] ws初始化"),this._createSocket()}_createSocket(){const e=W();this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.socket=new WebSocket("ws://154.219.124.188:8887"),this.socket.addEventListener("open",()=>{console.log("[socket] 连接成功"),this.isConnected=!0,this.reconnectAttempts=0}),this.socket.addEventListener("close",t=>{console.log("[socket] 连接已关闭:",t.reason),this.isConnected=!1,this.handleReconnect()}),this.socket.addEventListener("error",t=>{console.log("[socket] 连接失败:",t),this.isConnected=!1,this.handleReconnect()}),this.socket.addEventListener("message",({data:t})=>{if(t=="连接成功"||t=="ping")return;const i=JSON.parse(t);i&&C.publish(e.wsKey,i)})}handleReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts){console.log("[socket] 达到最大重连次数，停止重连");return}this.reconnectAttempts++,console.log(`[socket] 尝试重连 (${this.reconnectAttempts}/${this.maxReconnectAttempts})`),this.reconnectTimer=window.setTimeout(()=>{console.log("[socket] 正在重连..."),this._createSocket()},this.reconnectInterval)}reconnect(){console.log("[socket] 手动触发重连"),this.reconnectAttempts=0,this.socket&&this.socket.close(),this._createSocket()}emit(e,t){if(!this.socket||this.socket.readyState!==WebSocket.OPEN){console.log("[socket] ws未连接，无法订阅");return}this.socket.send(JSON.stringify(f({op:e},t)))}subscribeOnStream(e){this.emit("subscribe",e)}unsubscribeFromStream(e){this.emit("unsubscribe",e)}close(){this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.socket&&(this.socket.close(),this.socket=null),this.isConnected=!1,this.reconnectAttempts=0}}const W=L("kline",()=>{const s=q(),e=B(),t=l({}),i=H({code:1,interval:"P1D",stockId:""}),n=l(null),r=l("kline"),p=l({chg:0,chgPct:0,open:0,high:0,low:0,close:0,volume:0,fundamentalMarketCap:0,stockName:""}),m=v=>{C.subscribe(r.value,(h,k)=>{s.stockDetail.stockCode&&s.stockDetail.stockCode==k.pid&&(Object.assign(p.value,{close:k.last_numeric,chgPct:k.pcp,chg:k.pc,high:k.high,low:k.low}),v(p.value))})},u=l(!1),g=()=>d(void 0,null,function*(){i.stockId=s.stockDetail.stockCode;try{const v=yield I(i);if(v.code===200){if(v.body.length===0){t.value=[];return}t.value=v.body.map(h=>({timestamp:+h.time,open:h.open,high:h.high,low:h.low,close:h.close,volume:h.volume})),p.value=f(f({},p.value),t.value[t.value.length-1]),T("chart"),yield a()}}finally{}}),x={grid:{show:!0,horizontal:{show:!0,color:e.isDark?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.1)"},vertical:{show:!0,color:e.isDark?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.1)"}},xAxis:{show:!0,axisLine:{show:!0,color:e.isDark?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.1)"},tickText:{format:v=>{const h=new Date(v);return Y(h)}}},yAxis:{show:!0,axisLine:{show:!0,color:e.isDark?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.1)"}},candle:{bar:{compareRule:"current_open",upColor:"#2DC08E",downColor:"#F92855",noChangeColor:"#888888",upBorderColor:"#2DC08E",downBorderColor:"#F92855",noChangeBorderColor:"#888888",upWickColor:"#2DC08E",downWickColor:"#F92855",noChangeWickColor:"#888888"},tooltip:{title:{show:!0,size:14,weight:"bold",color:e.isDark?"#fff":"#000",template:"{ticker} · {period}"},legend:{size:8,weight:"normal",defaultValue:"n/a",template:[{title:{text:"time",color:"#888888"},value:{text:"{time}",color:"#e74032"}},{title:{text:"open",color:"#888888"},value:{text:"{open}",color:"#e74032"}},{title:{text:"high",color:"#888888"},value:{text:"{high}",color:"#e74032"}},{title:{text:"low",color:"#888888"},value:{text:"{low}",color:"#e74032"}},{title:{text:"close",color:"#888888"},value:{text:"{close}",color:"#e74032"}},{title:{text:"volume",color:"#888888"},value:{text:"{volume}",color:"#e74032"}}]}}}},D=l([{name:"5m",value:"PT5M",span:"5",type:"minute"},{name:"15m",value:"PT15M",span:"15",type:"minute"},{name:"1H",value:"PT1H",span:"1",type:"hour"},{name:"1D",value:"P1D",span:"1",type:"day"},{name:"1W",value:"P1W",span:"1",type:"week"},{name:"1M",value:"P1M",span:"1",type:"month"}]),b=l(D.value[2]),a=()=>new Promise((v,h)=>{n.value=V("chart"),n.value.setSymbol({ticker:s.stockDetail.symbol}),n.value.setPeriod({span:b.value.span,type:b.value.type}),n.value.setStyles(x),n.value.setZoomEnabled(!0),n.value.setTimezone("Asia/Kolkata"),n.value.setScrollEnabled(!0),n.value.setDataLoader({getBars:({callback:k})=>{k(t.value),v(t.value)},subscribeBar:({callback:k})=>{m(k)}})});$(()=>{T("chart"),C.unsubscribe(r.value)});const c=l(null),o=()=>{c.value=new Z};return U(()=>{o()}),{getKlineData:g,initChart:a,initWs:o,klineLoading:u,ws:c,wsKey:r,selectedResolution:b,activeList:D,chart:n,klineParams:i,klineData:t,klineShowData:p}}),q=L("stock",()=>{const s=W(),e=l({}),t=a=>d(void 0,null,function*(){const c=yield y.show();try{const o=yield K(a);o.code===200&&(e.value=o.body,s.klineShowData=P(f({},s.klineShowData),{stockName:e.value.stockName,chg:e.value.chg,chgPct:e.value.chgPct,open:e.value.open,high:e.value.high,low:e.value.low,close:e.value.close,volume:e.value.volume,fundamentalMarketCap:e.value.fundamentalMarketCap}))}catch(o){c.close()}finally{c.close()}}),i=l([]),n=l([]),r=l([]),p=a=>d(void 0,null,function*(){try{const c=yield O({stockCode:a});c.code===200&&(i.value=c.body,i.value.forEach(o=>{o.last_dir=="greenBg"?(n.value.length>=5&&n.value.pop(),n.value.unshift(o)):o.last_dir=="redBg"&&(r.value.length>=5&&r.value.pop(),r.value.unshift(o))}))}catch(c){}}),m=l({}),u=a=>d(void 0,null,function*(){const c=yield y.show();try{const o=yield z({id:a});o.code===200&&(m.value=o.body)}catch(o){c.close()}finally{c.close()}}),g=l({});return{stockDetail:e,stockWsDepth:i,buyList:n,sellList:r,newsDetail:m,positionDetail:g,sellStock:a=>d(void 0,null,function*(){const c=yield y.show();try{yield j({orderSn:a})}catch(o){c.close()}finally{c.close()}}),getCloseDetail:a=>d(void 0,null,function*(){const c=yield y.show();try{const o=yield J(a);o.code===200&&(g.value=o.body)}catch(o){c.close()}finally{c.close()}}),getPositionDetail:a=>d(void 0,null,function*(){const c=yield y.show();try{const o=yield F(a);o.code===200&&(g.value=o.body)}catch(o){c.close()}finally{c.close()}}),getNewsDetail:u,getStockWsDepth:p,getStockDetail:t}});export{W as a,q as u};
